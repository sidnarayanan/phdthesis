#!/bin/bash 

function BUILD {
    echo $@ | pdflatex main.tex
    echo $@ | pdflatex main.tex # do it twice to force toc recompilation
}
TARGET=main.pdf

if [ "$1" == "clean" ]; then
    cmd="rm -f *log *aux *toc *lot *lof main.pdf"
    echo $cmd
    $cmd
elif ! [ -f $TARGET ]; then
    BUILD all
elif ! [ "$1" == "" ]; then
    BUILD $1
else
    TARGETMODIFIED=$(stat -c %Z $TARGET)
    TOBUILD=""
    for TEX in $(ls *tex | grep -v main.tex); do
        MODIFIED=$(stat -c %Z $TEX)
        if [[ $MODIFIED > $TARGETMODIFIED ]]; then
	    TOBUILD=${TOBUILD}$(echo ${TEX} | sed 's?.tex$??')","
        fi
    done
    TOBUILD=$(echo $TOBUILD | sed 's?,$??')
    if [ "$TOBUILD" == "" ]; then
        echo "Nothing to build!"
        exit 0;
    fi 
    echo "Building: "$TOBUILD
    echo $TOBUILD | pdflatex main.tex
fi
